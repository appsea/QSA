"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var appSettings = require("application-settings");
var navigationModule = require("../shared/navigation");
var SETTINGS = "SETTINGS";
var SettingsService = /** @class */ (function () {
    function SettingsService() {
        this.DEFAULT_SETTING = { totalQuestionsMain: 67, totalQuestionsQuick: 15 };
        this.DEFAULT_MAIN_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsMain
        };
        this.DEFAULT_QUICK_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsQuick
        };
        this.clearAll();
        this.createSetting();
    }
    SettingsService.getInstance = function () {
        return SettingsService._instance;
    };
    SettingsService.prototype.createSetting = function () {
        if (appSettings.hasKey(SETTINGS)) {
            var cacheSet = this.readSettings();
            this.DEFAULT_MAIN_STATE.totalQuestions = cacheSet.totalQuestionsMain;
            this.DEFAULT_QUICK_STATE.totalQuestions = cacheSet.totalQuestionsQuick;
        }
        if (!appSettings.hasKey(SettingsService.MAIN)) {
            this.saveCache(SettingsService.MAIN, this.DEFAULT_MAIN_STATE);
        }
        if (!appSettings.hasKey(SettingsService.QUICK)) {
            this.saveCache(SettingsService.QUICK, this.DEFAULT_QUICK_STATE);
        }
    };
    SettingsService.prototype.readSettings = function () {
        var setting;
        try {
            setting = appSettings.hasKey(SETTINGS) ? JSON.parse(appSettings.getString(SETTINGS)) :
                this.DEFAULT_SETTING;
        }
        catch (error) {
            setting = this.DEFAULT_SETTING;
        }
        return setting;
    };
    SettingsService.prototype.readCache = function (mode) {
        var state = appSettings.hasKey(mode) ? JSON.parse(appSettings.getString(mode)) : mode === SettingsService.MAIN ? this.DEFAULT_MAIN_STATE : this.DEFAULT_QUICK_STATE;
        return state;
    };
    SettingsService.prototype.saveCache = function (mode, state) {
        var newState = JSON.stringify(state);
        appSettings.setString(mode, newState);
    };
    SettingsService.prototype.clearCache = function (mode) {
        appSettings.remove(mode);
    };
    SettingsService.prototype.clearAll = function () {
        if (SettingsService.CLEAR || !appSettings.hasKey(SettingsService.VERSION) || appSettings.getNumber(SettingsService.VERSION) < SettingsService.VERSION_NUMBER) {
            this.clearCache(SettingsService.MAIN);
            this.clearCache(SettingsService.QUICK);
            this.clearCache(SettingsService.QUESTIONS);
            this.clearCache(SettingsService.QUICK1);
            this.clearCache(SettingsService.ROUTE);
        }
        this.clearCache(SettingsService.PRACTICE);
        appSettings.setNumber(SettingsService.VERSION, SettingsService.VERSION_NUMBER);
    };
    SettingsService.prototype.saveSetting = function (setting) {
        var newSetting = JSON.stringify(setting);
        appSettings.setString(SETTINGS, newSetting);
        var state = this.readCache(SettingsService.MAIN);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsMain;
            this.saveCache(SettingsService.MAIN, state);
        }
        state = this.readCache(SettingsService.QUICK);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsQuick;
            this.saveCache(SettingsService.QUICK, state);
        }
    };
    SettingsService.prototype.saveQuestions = function (questions) {
        var json = JSON.stringify(questions);
        appSettings.setString(SettingsService.QUESTIONS, json);
    };
    SettingsService.prototype.readQuestions = function () {
        var questions;
        try {
            questions = this.hasQuestions() ? JSON.parse(appSettings.getString(SettingsService.QUESTIONS)) : [];
        }
        catch (error) {
            questions = [];
        }
        return questions;
    };
    SettingsService.prototype.saveRoute = function (path) {
        appSettings.setString(SettingsService.ROUTE, path);
    };
    SettingsService.prototype.getRoute = function () {
        if (appSettings.hasKey(SettingsService.ROUTE)) {
            return appSettings.getString(SettingsService.ROUTE);
        }
        return "question/practice";
    };
    SettingsService.prototype.saveScore = function (mode, percentage) {
        var key = 'stats' + mode;
        if (appSettings.hasKey(key)) {
            var items = JSON.parse(appSettings.getString(key));
            if (items.length >= 5) {
                items.shift();
            }
            items.push(percentage);
            appSettings.setString(key, JSON.stringify(items));
        }
        else {
            var items = new Array();
            items.push(percentage);
            appSettings.setString(key, JSON.stringify(items));
        }
    };
    SettingsService.prototype.getScore = function (mode) {
        var key = 'stats' + mode;
        var items = [];
        if (appSettings.hasKey(key)) {
            items = JSON.parse(appSettings.getString(key));
        }
        return items;
    };
    SettingsService.prototype.hasQuestions = function () {
        return appSettings.hasKey(SettingsService.QUESTIONS);
    };
    SettingsService.route = function () {
        var path = SettingsService.getInstance().getRoute();
        if (!path.includes(SettingsService.PRACTICE)) {
            navigationModule.toPage(path);
            return true;
        }
        return false;
    };
    SettingsService.VERSION_NUMBER = 9;
    SettingsService.CLEAR = false;
    SettingsService.VERSION = "VERSION";
    SettingsService.MAIN = "main";
    SettingsService.QUICK = "quick";
    SettingsService.QUICK1 = "short";
    SettingsService.PRACTICE = "practice";
    SettingsService.ROUTE = "route";
    SettingsService.QUESTIONS = "questions";
    SettingsService._instance = new SettingsService();
    return SettingsService;
}());
exports.SettingsService = SettingsService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNldHRpbmdzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrREFBb0Q7QUFFcEQsdURBQXlEO0FBRXpELElBQU0sUUFBUSxHQUFVLFVBQVUsQ0FBQztBQUVuQztJQStCSTtRQXBCQSxvQkFBZSxHQUFhLEVBQUMsa0JBQWtCLEVBQUUsRUFBRSxFQUFFLG1CQUFtQixFQUFFLEVBQUUsRUFBQyxDQUFDO1FBQzlFLHVCQUFrQixHQUFVO1lBQ3hCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsY0FBYyxFQUFFLENBQUM7WUFDakIsY0FBYyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsa0JBQWtCO1NBQzFELENBQUM7UUFFTSx3QkFBbUIsR0FBVTtZQUNqQyxTQUFTLEVBQUUsRUFBRTtZQUNiLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLGNBQWMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQjtTQUMzRCxDQUFDO1FBVUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBVE0sMkJBQVcsR0FBbEI7UUFDSSxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztJQUNyQyxDQUFDO0lBU00sdUNBQWEsR0FBcEI7UUFDSSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixJQUFNLFFBQVEsR0FBYSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDL0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUMsa0JBQWtCLENBQUM7WUFDckUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUMsbUJBQW1CLENBQUM7UUFDM0UsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMs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LENBQUMsQ0FBQztJQUMzQixxQkFBSyxHQUFZLEtBQUssQ0FBQztJQUN2Qix1QkFBTyxHQUFXLFNBQVMsQ0FBQztJQUM1QixvQkFBSSxHQUFXLE1BQU0sQ0FBQztJQUN0QixxQkFBSyxHQUFXLE9BQU8sQ0FBQztJQUN4QixzQkFBTSxHQUFXLE9BQU8sQ0FBQztJQUN6Qix3QkFBUSxHQUFXLFVBQVUsQ0FBQztJQUM5QixxQkFBSyxHQUFXLE9BQU8sQ0FBQztJQUN4Qix5QkFBUyxHQUFXLFdBQVcsQ0FBQztJQW1CeEIseUJBQVMsR0FBb0IsSUFBSSxlQUFlLEVBQUUsQ0FBQztJQXdJdEUsc0JBQUM7Q0FBQSxBQXJLRCxJQXFLQztBQXJLWSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFwcFNldHRpbmdzIGZyb20gJ2FwcGxpY2F0aW9uLXNldHRpbmdzJztcclxuaW1wb3J0IHtJUXVlc3Rpb24sIElTZXR0aW5nLCBTdGF0ZX0gZnJvbSBcIi4uL3NoYXJlZC9xdWVzdGlvbnMubW9kZWxcIjtcclxuaW1wb3J0ICogYXMgbmF2aWdhdGlvbk1vZHVsZSBmcm9tICcuLi9zaGFyZWQvbmF2aWdhdGlvbic7XHJcblxyXG5jb25zdCBTRVRUSU5HUzpzdHJpbmcgPSBcIlNFVFRJTkdTXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgU2V0dGluZ3NTZXJ2aWNlIHtcclxuXHJcbiAgICBzdGF0aWMgVkVSU0lPTl9OVU1CRVI6IG51bWJlciA9IDk7XHJcbiAgICBzdGF0aWMgQ0xFQVI6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHN0YXRpYyBWRVJTSU9OOiBzdHJpbmcgPSBcIlZFUlNJT05cIjtcclxuICAgIHN0YXRpYyBNQUlOOiBzdHJpbmcgPSBcIm1haW5cIjtcclxuICAgIHN0YXRpYyBRVUlDSzogc3RyaW5nID0gXCJxdWlja1wiO1xyXG4gICAgc3RhdGljIFFVSUNLMTogc3RyaW5nID0gXCJzaG9ydFwiO1xyXG4gICAgc3RhdGljIFBSQUNUSUNFOiBzdHJpbmcgPSBcInByYWN0aWNlXCI7XHJcbiAgICBzdGF0aWMgUk9VVEU6IHN0cmluZyA9IFwicm91dGVcIjtcclxuICAgIHN0YXRpYyBRVUVTVElPTlM6IHN0cmluZyA9IFwicXVlc3Rpb25zXCI7XHJcbiAgICBERUZBVUxUX1NFVFRJTkc6IElTZXR0aW5nID0ge3RvdGFsUXVlc3Rpb25zTWFpbjogNjcsIHRvdGFsUXVlc3Rpb25zUXVpY2s6IDE1fTtcclxuICAgIERFRkFVTFRfTUFJTl9TVEFURTogU3RhdGUgPSB7XHJcbiAgICAgICAgcXVlc3Rpb25zOiBbXSxcclxuICAgICAgICBxdWVzdGlvbk51bWJlcjogMCxcclxuICAgICAgICB0b3RhbFF1ZXN0aW9uczogdGhpcy5ERUZBVUxUX1NFVFRJTkcudG90YWxRdWVzdGlvbnNNYWluXHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgREVGQVVMVF9RVUlDS19TVEFURTogU3RhdGUgPSB7XHJcbiAgICAgICAgcXVlc3Rpb25zOiBbXSxcclxuICAgICAgICBxdWVzdGlvbk51bWJlcjogMCxcclxuICAgICAgICB0b3RhbFF1ZXN0aW9uczogdGhpcy5ERUZBVUxUX1NFVFRJTkcudG90YWxRdWVzdGlvbnNRdWlja1xyXG4gICAgfTtcclxuXHJcblxyXG4gICAgc3RhdGljIGdldEluc3RhbmNlKCk6IFNldHRpbmdzU2VydmljZSB7XHJcbiAgICAgICAgcmV0dXJuIFNldHRpbmdzU2VydmljZS5faW5zdGFuY2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBTZXR0aW5nc1NlcnZpY2UgPSBuZXcgU2V0dGluZ3NTZXJ2aWNlKCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKXtcclxuICAgICAgICB0aGlzLmNsZWFyQWxsKCk7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVTZXR0aW5nKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNyZWF0ZVNldHRpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGFwcFNldHRpbmdzLmhhc0tleShTRVRUSU5HUykpIHtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGVTZXQ6IElTZXR0aW5nID0gdGhpcy5yZWFkU2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgdGhpcy5ERUZBVUxUX01BSU5fU1RBVEUudG90YWxRdWVzdGlvbnMgPSBjYWNoZVNldC50b3RhbFF1ZXN0aW9uc01haW47XHJcbiAgICAgICAgICAgIHRoaXMuREVGQVVMVF9RVUlDS19TVEFURS50b3RhbFF1ZXN0aW9ucyA9IGNhY2hlU2V0LnRvdGFsUXVlc3Rpb25zUXVpY2s7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5NQUlOKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNhdmVDYWNoZShTZXR0aW5nc1NlcnZpY2UuTUFJTiwgdGhpcy5ERUZBVUxUX01BSU5fU1RBVEUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWFwcFNldHRpbmdzLmhhc0tleShTZXR0aW5nc1NlcnZpY2UuUVVJQ0spKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZUNhY2hlKFNldHRpbmdzU2VydmljZS5RVUlDSywgdGhpcy5ERUZBVUxUX1FVSUNLX1NUQVRFKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVhZFNldHRpbmdzKCk6IElTZXR0aW5nIHtcclxuICAgICAgICBsZXQgc2V0dGluZzogSVNldHRpbmc7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgc2V0dGluZyA9IGFwcFNldHRpbmdzLmhhc0tleShTRVRUSU5HUykgPyBKU09OLnBhcnNlKGFwcFNldHRpbmdzLmdldFN0cmluZyhTRVRUSU5HUykpIDpcclxuICAgICAgICAgICAgICAgIHRoaXMuREVGQVVMVF9TRVRUSU5HO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHNldHRpbmcgPSB0aGlzLkRFRkFVTFRfU0VUVElORztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHNldHRpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgcmVhZENhY2hlKG1vZGU6IHN0cmluZyk6IFN0YXRlIHtcclxuICAgICAgICBsZXQgc3RhdGU6IFN0YXRlID0gYXBwU2V0dGluZ3MuaGFzS2V5KG1vZGUpID8gSlNPTi5wYXJzZShhcHBTZXR0aW5ncy5nZXRTdHJpbmcobW9kZSkpIDogbW9kZSA9PT0gU2V0dGluZ3NTZXJ2aWNlLk1BSU4/IHRoaXMuREVGQVVMVF9NQUlOX1NUQVRFOiB0aGlzLkRFRkFVTFRfUVVJQ0tfU1RBVEU7XHJcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVDYWNoZShtb2RlOiBzdHJpbmcsIHN0YXRlOiBTdGF0ZSk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG5ld1N0YXRlOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShzdGF0ZSk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKG1vZGUsIG5ld1N0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckNhY2hlKG1vZGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnJlbW92ZShtb2RlKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckFsbCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAoU2V0dGluZ3NTZXJ2aWNlLkNMRUFSIHx8ICFhcHBTZXR0aW5ncy5oYXNLZXkoU2V0dGluZ3NTZXJ2aWNlLlZFUlNJT04pIHx8IGFwcFNldHRpbmdzLmdldE51bWJlcihTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTikgPCBTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTl9OVU1CRVIpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOKTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5RVUlDSyk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TKTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5RVUlDSzEpO1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlJPVVRFKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5QUkFDVElDRSk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0TnVtYmVyKFNldHRpbmdzU2VydmljZS5WRVJTSU9OLCBTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTl9OVU1CRVIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVTZXR0aW5nKHNldHRpbmc6IElTZXR0aW5nKSB7XHJcbiAgICAgICAgY29uc3QgbmV3U2V0dGluZzogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoc2V0dGluZyk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKFNFVFRJTkdTLCBuZXdTZXR0aW5nKTtcclxuICAgICAgICBsZXQgc3RhdGU6IFN0YXRlID0gdGhpcy5yZWFkQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLk1BSU4pO1xyXG4gICAgICAgIGlmIChzZXR0aW5nLnRvdGFsUXVlc3Rpb25zTWFpbiA+IHN0YXRlLnRvdGFsUXVlc3Rpb25zKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnRvdGFsUXVlc3Rpb25zID0gc2V0dGluZy50b3RhbFF1ZXN0aW9uc01haW47XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZUNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOLCBzdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN0YXRlID0gdGhpcy5yZWFkQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLKTtcclxuICAgICAgICBpZiAoc2V0dGluZy50b3RhbFF1ZXN0aW9uc01haW4gPiBzdGF0ZS50b3RhbFF1ZXN0aW9ucykge1xyXG4gICAgICAgICAgICBzdGF0ZS50b3RhbFF1ZXN0aW9ucyA9IHNldHRpbmcudG90YWxRdWVzdGlvbnNRdWljaztcclxuICAgICAgICAgICAgdGhpcy5zYXZlQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLLCBzdGF0ZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVF1ZXN0aW9ucyhxdWVzdGlvbnM6IEFycmF5PElRdWVzdGlvbj4pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBqc29uOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShxdWVzdGlvbnMpO1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnNldFN0cmluZyhTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TLCBqc29uKTtcclxuICAgIH1cclxuXHJcbiAgICByZWFkUXVlc3Rpb25zKCk6IEFycmF5PElRdWVzdGlvbj4ge1xyXG4gICAgICAgIGxldCBxdWVzdGlvbnM6IEFycmF5PElRdWVzdGlvbj47XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcXVlc3Rpb25zID0gdGhpcy5oYXNRdWVzdGlvbnMoKSA/IEpTT04ucGFyc2UoYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMpKSA6IFtdO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9ucyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcXVlc3Rpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVSb3V0ZShwYXRoOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBhcHBTZXR0aW5ncy5zZXRTdHJpbmcoU2V0dGluZ3NTZXJ2aWNlLlJPVVRFLCBwYXRoKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRSb3V0ZSgpOiBzdHJpbmd7XHJcbiAgICAgICAgaWYoYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5ST1VURSkpe1xyXG4gICAgICAgICAgICByZXR1cm4gYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKFNldHRpbmdzU2VydmljZS5ST1VURSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBcInF1ZXN0aW9uL3ByYWN0aWNlXCI7XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVNjb3JlKG1vZGU6IHN0cmluZywgcGVyY2VudGFnZTogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgbGV0IGtleSA9ICdzdGF0cycgKyBtb2RlO1xyXG4gICAgICAgIGlmIChhcHBTZXR0aW5ncy5oYXNLZXkoa2V5KSkge1xyXG4gICAgICAgICAgICBsZXQgaXRlbXM6IEFycmF5PG51bWJlcj4gPSBKU09OLnBhcnNlKGFwcFNldHRpbmdzLmdldFN0cmluZyhrZXkpKTtcclxuICAgICAgICAgICAgaWYoaXRlbXMubGVuZ3RoID49IDUpe1xyXG4gICAgICAgICAgICAgICAgaXRlbXMuc2hpZnQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpdGVtcy5wdXNoKHBlcmNlbnRhZ2UpO1xyXG4gICAgICAgICAgICBhcHBTZXR0aW5ncy5zZXRTdHJpbmcoa2V5LCBKU09OLnN0cmluZ2lmeShpdGVtcykpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCBpdGVtcyA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgICAgICBpdGVtcy5wdXNoKHBlcmNlbnRhZ2UpO1xyXG4gICAgICAgICAgICBhcHBTZXR0aW5ncy5zZXRTdHJpbmcoa2V5LCBKU09OLnN0cmluZ2lmeShpdGVtcykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTY29yZShtb2RlOiBzdHJpbmcpOiBBcnJheTxudW1iZXI+IHtcclxuICAgICAgICBsZXQga2V5ID0gJ3N0YXRzJyArIG1vZGU7XHJcbiAgICAgICAgbGV0IGl0ZW1zOkFycmF5PG51bWJlcj4gPSBbXTtcclxuICAgICAgICBpZiAoYXBwU2V0dGluZ3MuaGFzS2V5KGtleSkpIHtcclxuICAgICAgICAgICAgaXRlbXMgPSBKU09OLnBhcnNlKGFwcFNldHRpbmdzLmdldFN0cmluZyhrZXkpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGl0ZW1zO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc1F1ZXN0aW9ucygpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyByb3V0ZSgpOiBib29sZWFuIHtcclxuICAgICAgICBsZXQgcGF0aCA9IFNldHRpbmdzU2VydmljZS5nZXRJbnN0YW5jZSgpLmdldFJvdXRlKCk7XHJcbiAgICAgICAgaWYgKCFwYXRoLmluY2x1ZGVzKFNldHRpbmdzU2VydmljZS5QUkFDVElDRSkpIHtcclxuICAgICAgICAgICAgbmF2aWdhdGlvbk1vZHVsZS50b1BhZ2UocGF0aCk7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbn0iXX0=