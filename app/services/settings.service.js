"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var appSettings = require("application-settings");
var SETTINGS = "SETTINGS";
var SettingsService = /** @class */ (function () {
    function SettingsService() {
        this.DEFAULT_SETTING = { totalQuestionsMain: 67, totalQuestionsQuick: 15 };
        this.DEFAULT_STATE = { questions: [], questionNumber: 0, totalQuestions: 15 };
        this.DEFAULT_MAIN_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsMain
        };
        this.DEFAULT_QUICK_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsQuick
        };
        this.clearAll();
        this.createSetting();
    }
    SettingsService.getInstance = function () {
        return SettingsService._instance;
    };
    SettingsService.prototype.createSetting = function () {
        if (appSettings.hasKey(SETTINGS)) {
            var cacheSet = this.readSettings();
            this.DEFAULT_MAIN_STATE.totalQuestions = cacheSet.totalQuestionsMain;
            this.DEFAULT_QUICK_STATE.totalQuestions = cacheSet.totalQuestionsQuick;
        }
        if (!appSettings.hasKey(SettingsService.MAIN)) {
            this.saveCache(SettingsService.MAIN, this.DEFAULT_MAIN_STATE);
        }
        if (!appSettings.hasKey(SettingsService.QUICK)) {
            this.saveCache(SettingsService.QUICK, this.DEFAULT_QUICK_STATE);
        }
    };
    SettingsService.prototype.readSettings = function () {
        var setting;
        try {
            setting = appSettings.hasKey(SETTINGS) ? JSON.parse(appSettings.getString(SETTINGS)) :
                this.DEFAULT_SETTING;
        }
        catch (error) {
            setting = this.DEFAULT_SETTING;
        }
        return setting;
    };
    SettingsService.prototype.readCache = function (mode) {
        var state;
        try {
            state = appSettings.hasKey(mode) ? JSON.parse(appSettings.getString(mode)) : this.DEFAULT_STATE;
        }
        catch (error) {
            state = this.DEFAULT_STATE;
        }
        return state;
    };
    SettingsService.prototype.saveCache = function (mode, state) {
        var newState = JSON.stringify(state);
        appSettings.setString(mode, newState);
    };
    SettingsService.prototype.clearCache = function (mode) {
        appSettings.remove(mode);
    };
    SettingsService.prototype.clearAll = function () {
        if (SettingsService.CLEAR || !appSettings.hasKey(SettingsService.VERSION) || appSettings.getNumber(SettingsService.VERSION) < SettingsService.VERSION_NUMBER) {
            this.clearCache(SettingsService.MAIN);
            this.clearCache(SettingsService.QUICK);
            this.clearCache(SettingsService.QUESTIONS);
            this.clearCache(SettingsService.QUICK1);
        }
        this.clearCache(SettingsService.PRACTICE);
        appSettings.setNumber(SettingsService.VERSION, SettingsService.VERSION_NUMBER);
    };
    SettingsService.prototype.saveSetting = function (setting) {
        var newSetting = JSON.stringify(setting);
        appSettings.setString(SETTINGS, newSetting);
        var state = this.readCache(SettingsService.MAIN);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsMain;
            this.saveCache(SettingsService.MAIN, state);
        }
        state = this.readCache(SettingsService.QUICK);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsQuick;
            this.saveCache(SettingsService.QUICK, state);
        }
    };
    SettingsService.prototype.saveQuestions = function (questions) {
        var json = JSON.stringify(questions);
        appSettings.setString(SettingsService.QUESTIONS, json);
    };
    SettingsService.prototype.readQuestions = function () {
        var questions;
        try {
            questions = this.hasQuestions() ? JSON.parse(appSettings.getString(SettingsService.QUESTIONS)) : [];
        }
        catch (error) {
            questions = [];
        }
        return questions;
    };
    SettingsService.prototype.hasQuestions = function () {
        return appSettings.hasKey(SettingsService.QUESTIONS);
    };
    SettingsService.VERSION_NUMBER = 9;
    SettingsService.CLEAR = false;
    SettingsService.VERSION = "VERSION";
    SettingsService.MAIN = "main";
    SettingsService.QUICK = "quick";
    SettingsService.QUICK1 = "short";
    SettingsService.PRACTICE = "practice";
    SettingsService.QUESTIONS = "questions";
    SettingsService._instance = new SettingsService();
    return SettingsService;
}());
exports.SettingsService = SettingsService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNldHRpbmdzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrREFBb0Q7QUFHcEQsSUFBTSxRQUFRLEdBQVUsVUFBVSxDQUFDO0FBRW5DO0lBK0JJO1FBckJBLG9CQUFlLEdBQWEsRUFBQyxrQkFBa0IsRUFBRSxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsRUFBRSxFQUFDLENBQUM7UUFDdEUsa0JBQWEsR0FBVSxFQUFDLFNBQVMsRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFFLENBQUMsRUFBRSxjQUFjLEVBQUUsRUFBRSxFQUFDLENBQUM7UUFDdEYsdUJBQWtCLEdBQVU7WUFDeEIsU0FBUyxFQUFFLEVBQUU7WUFDYixjQUFjLEVBQUUsQ0FBQztZQUNqQixjQUFjLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxrQkFBa0I7U0FDMUQsQ0FBQztRQUVNLHdCQUFtQixHQUFVO1lBQ2pDLFNBQVMsRUFBRSxFQUFFO1lBQ2IsY0FBYyxFQUFFLENBQUM7WUFDakIsY0FBYyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CO1NBQzNELENBQUM7UUFVRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFUTSwyQkFBVyxHQUFsQjtRQUNJLE1BQU0sQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDO0lBQ3JDLENBQUM7SUFTTSx1Q0FBYSxHQUFwQjtRQUNJLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9CLElBQU0sUUFBUSxHQUFhLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUMvQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQztZQUNyRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQztRQUMzRSxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDcEUsQ0FBQztJQUNMLENBQUM7SUFFRCxzQ0FBWSxHQUFaO1FBQ0ksSUFBSSxPQUFpQixDQUFDO1FBQ3RCLElBQUksQ0FBQztZQUNELE9BQU8sR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNsRixJQUFJLENBQUMsZUFBZSxDQUFDO1FBQzdCLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2IsT0FBTyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7UUFDbkMsQ0FBQztRQUNELE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVELG1DQUFTLEdBQVQsVUFBVSxJQUFZO1FBQ2xCLElBQUksS0FBWSxDQUFDO1FBQ2pCLElBQUksQ0FBQztZQUNELEtBQUssR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUNwRyxDQUFDO1FBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNiLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQy9CLENBQUM7UUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxtQ0FBUyxHQUFULFVBQVUsSUFBWSxFQUFFLEtBQVk7UUFDaEMsSUFBTSxRQUFRLEdBQVcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsb0NBQVUsR0FBVixVQUFXLElBQVk7UUFDbkIsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsa0NBQVEsR0FBUjtRQUNJLEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxLQUFLLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxXQUFXLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsR0FBRyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUMzSixJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMzQyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QyxDQUFDO1FBQ0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLGVBQWUsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNuRixDQUFDO0lBRUQscUNBQVcsR0FBWCxVQUFZLE9BQWlCO1FBQ3pCLElBQU0sVUFBVSxHQUFXLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkQsV0FBVyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDNUMsSUFBSSxLQUFLLEdBQVUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEQsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1lBQ3BELEtBQUssQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDO1lBQ2xELElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRCxDQUFDO1FBQ0QsS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUNwRCxLQUFLLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztZQUNuRCxJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDaEQsQ0FBQztJQUNMLENBQUM7SUFFRCx1Q0FBYSxHQUFiLFVBQWMsU0FBMkI7UUFDckMsSUFBTSxJQUFJLEdBQVcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMvQyxXQUFXLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELHVDQUFhLEdBQWI7UUFDSSxJQUFJLFNBQTJCLENBQUM7UUFDaEMsSUFBSSxDQUFDO1lBQ0QsU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDeEcsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDYixTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ25CLENBQUM7UUFDRCxNQUFNLENBQUMsU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxzQ0FBWSxHQUFaO1FBQ0ksTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUF6SE0sOEJBQWMsR0FBVyxDQUFDLENBQUM7SUFDM0IscUJBQUssR0FBWSxLQUFLLENBQUM7SUFDdkIsdUJBQU8sR0FBVyxTQUFTLENBQUM7SUFDNUIsb0JBQUksR0FBVyxNQUFNLENBQUM7SUFDdEIscUJBQUssR0FBVyxPQUFPLENBQUM7SUFDeEIsc0JBQU0sR0FBVyxPQUFPLENBQUM7SUFDekIsd0JBQVEsR0FBVyxVQUFVLENBQUM7SUFDOUIseUJBQVMsR0FBVyxXQUFXLENBQUM7SUFvQnhCLHlCQUFTLEdBQW9CLElBQUksZUFBZSxFQUFFLENBQUM7SUErRnRFLHNCQUFDO0NBQUEsQUE1SEQsSUE0SEM7QUE1SFksMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhcHBTZXR0aW5ncyBmcm9tICdhcHBsaWNhdGlvbi1zZXR0aW5ncyc7XHJcbmltcG9ydCB7SVF1ZXN0aW9uLCBJU2V0dGluZywgU3RhdGV9IGZyb20gXCIuLi9zaGFyZWQvcXVlc3Rpb25zLm1vZGVsXCI7XHJcblxyXG5jb25zdCBTRVRUSU5HUzpzdHJpbmcgPSBcIlNFVFRJTkdTXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgU2V0dGluZ3NTZXJ2aWNlIHtcclxuXHJcbiAgICBzdGF0aWMgVkVSU0lPTl9OVU1CRVI6IG51bWJlciA9IDk7XHJcbiAgICBzdGF0aWMgQ0xFQVI6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHN0YXRpYyBWRVJTSU9OOiBzdHJpbmcgPSBcIlZFUlNJT05cIjtcclxuICAgIHN0YXRpYyBNQUlOOiBzdHJpbmcgPSBcIm1haW5cIjtcclxuICAgIHN0YXRpYyBRVUlDSzogc3RyaW5nID0gXCJxdWlja1wiO1xyXG4gICAgc3RhdGljIFFVSUNLMTogc3RyaW5nID0gXCJzaG9ydFwiO1xyXG4gICAgc3RhdGljIFBSQUNUSUNFOiBzdHJpbmcgPSBcInByYWN0aWNlXCI7XHJcbiAgICBzdGF0aWMgUVVFU1RJT05TOiBzdHJpbmcgPSBcInF1ZXN0aW9uc1wiO1xyXG4gICAgREVGQVVMVF9TRVRUSU5HOiBJU2V0dGluZyA9IHt0b3RhbFF1ZXN0aW9uc01haW46IDY3LCB0b3RhbFF1ZXN0aW9uc1F1aWNrOiAxNX07XHJcbiAgICBwcml2YXRlIERFRkFVTFRfU1RBVEU6IFN0YXRlID0ge3F1ZXN0aW9uczogW10sIHF1ZXN0aW9uTnVtYmVyOiAwLCB0b3RhbFF1ZXN0aW9uczogMTV9O1xyXG4gICAgREVGQVVMVF9NQUlOX1NUQVRFOiBTdGF0ZSA9IHtcclxuICAgICAgICBxdWVzdGlvbnM6IFtdLFxyXG4gICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgIHRvdGFsUXVlc3Rpb25zOiB0aGlzLkRFRkFVTFRfU0VUVElORy50b3RhbFF1ZXN0aW9uc01haW5cclxuICAgIH07XHJcblxyXG4gICAgcHJpdmF0ZSBERUZBVUxUX1FVSUNLX1NUQVRFOiBTdGF0ZSA9IHtcclxuICAgICAgICBxdWVzdGlvbnM6IFtdLFxyXG4gICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgIHRvdGFsUXVlc3Rpb25zOiB0aGlzLkRFRkFVTFRfU0VUVElORy50b3RhbFF1ZXN0aW9uc1F1aWNrXHJcbiAgICB9O1xyXG5cclxuXHJcbiAgICBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogU2V0dGluZ3NTZXJ2aWNlIHtcclxuICAgICAgICByZXR1cm4gU2V0dGluZ3NTZXJ2aWNlLl9pbnN0YW5jZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2U6IFNldHRpbmdzU2VydmljZSA9IG5ldyBTZXR0aW5nc1NlcnZpY2UoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcigpe1xyXG4gICAgICAgIHRoaXMuY2xlYXJBbGwoKTtcclxuICAgICAgICB0aGlzLmNyZWF0ZVNldHRpbmcoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY3JlYXRlU2V0dGluZygpOiB2b2lkIHtcclxuICAgICAgICBpZiAoYXBwU2V0dGluZ3MuaGFzS2V5KFNFVFRJTkdTKSkge1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZVNldDogSVNldHRpbmcgPSB0aGlzLnJlYWRTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICB0aGlzLkRFRkFVTFRfTUFJTl9TVEFURS50b3RhbFF1ZXN0aW9ucyA9IGNhY2hlU2V0LnRvdGFsUXVlc3Rpb25zTWFpbjtcclxuICAgICAgICAgICAgdGhpcy5ERUZBVUxUX1FVSUNLX1NUQVRFLnRvdGFsUXVlc3Rpb25zID0gY2FjaGVTZXQudG90YWxRdWVzdGlvbnNRdWljaztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFhcHBTZXR0aW5ncy5oYXNLZXkoU2V0dGluZ3NTZXJ2aWNlLk1BSU4pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZUNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOLCB0aGlzLkRFRkFVTFRfTUFJTl9TVEFURSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5RVUlDSykpIHtcclxuICAgICAgICAgICAgdGhpcy5zYXZlQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLLCB0aGlzLkRFRkFVTFRfUVVJQ0tfU1RBVEUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZWFkU2V0dGluZ3MoKTogSVNldHRpbmcge1xyXG4gICAgICAgIGxldCBzZXR0aW5nOiBJU2V0dGluZztcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBzZXR0aW5nID0gYXBwU2V0dGluZ3MuaGFzS2V5KFNFVFRJTkdTKSA/IEpTT04ucGFyc2UoYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKFNFVFRJTkdTKSkgOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5ERUZBVUxUX1NFVFRJTkc7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgc2V0dGluZyA9IHRoaXMuREVGQVVMVF9TRVRUSU5HO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc2V0dGluZztcclxuICAgIH1cclxuXHJcbiAgICByZWFkQ2FjaGUobW9kZTogc3RyaW5nKTogU3RhdGUge1xyXG4gICAgICAgIGxldCBzdGF0ZTogU3RhdGU7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgc3RhdGUgPSBhcHBTZXR0aW5ncy5oYXNLZXkobW9kZSkgPyBKU09OLnBhcnNlKGFwcFNldHRpbmdzLmdldFN0cmluZyhtb2RlKSkgOiB0aGlzLkRFRkFVTFRfU1RBVEU7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgc3RhdGUgPSB0aGlzLkRFRkFVTFRfU1RBVEU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzdGF0ZTtcclxuICAgIH1cclxuXHJcbiAgICBzYXZlQ2FjaGUobW9kZTogc3RyaW5nLCBzdGF0ZTogU3RhdGUpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBuZXdTdGF0ZTogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoc3RhdGUpO1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnNldFN0cmluZyhtb2RlLCBuZXdTdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJDYWNoZShtb2RlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBhcHBTZXR0aW5ncy5yZW1vdmUobW9kZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJBbGwoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKFNldHRpbmdzU2VydmljZS5DTEVBUiB8fCAhYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5WRVJTSU9OKSB8fCBhcHBTZXR0aW5ncy5nZXROdW1iZXIoU2V0dGluZ3NTZXJ2aWNlLlZFUlNJT04pIDwgU2V0dGluZ3NTZXJ2aWNlLlZFUlNJT05fTlVNQkVSKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShTZXR0aW5nc1NlcnZpY2UuTUFJTik7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVJQ0spO1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVRVNUSU9OUyk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVJQ0sxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5QUkFDVElDRSk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0TnVtYmVyKFNldHRpbmdzU2VydmljZS5WRVJTSU9OLCBTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTl9OVU1CRVIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVTZXR0aW5nKHNldHRpbmc6IElTZXR0aW5nKSB7XHJcbiAgICAgICAgY29uc3QgbmV3U2V0dGluZzogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoc2V0dGluZyk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKFNFVFRJTkdTLCBuZXdTZXR0aW5nKTtcclxuICAgICAgICBsZXQgc3RhdGU6IFN0YXRlID0gdGhpcy5yZWFkQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLk1BSU4pO1xyXG4gICAgICAgIGlmIChzZXR0aW5nLnRvdGFsUXVlc3Rpb25zTWFpbiA+IHN0YXRlLnRvdGFsUXVlc3Rpb25zKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnRvdGFsUXVlc3Rpb25zID0gc2V0dGluZy50b3RhbFF1ZXN0aW9uc01haW47XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZUNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOLCBzdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN0YXRlID0gdGhpcy5yZWFkQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLKTtcclxuICAgICAgICBpZiAoc2V0dGluZy50b3RhbFF1ZXN0aW9uc01haW4gPiBzdGF0ZS50b3RhbFF1ZXN0aW9ucykge1xyXG4gICAgICAgICAgICBzdGF0ZS50b3RhbFF1ZXN0aW9ucyA9IHNldHRpbmcudG90YWxRdWVzdGlvbnNRdWljaztcclxuICAgICAgICAgICAgdGhpcy5zYXZlQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLLCBzdGF0ZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVF1ZXN0aW9ucyhxdWVzdGlvbnM6IEFycmF5PElRdWVzdGlvbj4pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBqc29uOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShxdWVzdGlvbnMpO1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnNldFN0cmluZyhTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TLCBqc29uKTtcclxuICAgIH1cclxuXHJcbiAgICByZWFkUXVlc3Rpb25zKCk6IEFycmF5PElRdWVzdGlvbj4ge1xyXG4gICAgICAgIGxldCBxdWVzdGlvbnM6IEFycmF5PElRdWVzdGlvbj47XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcXVlc3Rpb25zID0gdGhpcy5oYXNRdWVzdGlvbnMoKSA/IEpTT04ucGFyc2UoYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMpKSA6IFtdO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9ucyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcXVlc3Rpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc1F1ZXN0aW9ucygpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMpO1xyXG4gICAgfVxyXG59Il19