"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var appSettings = require("application-settings");
var SETTINGS = "SETTINGS";
var SettingsService = /** @class */ (function () {
    function SettingsService() {
        this.DEFAULT_SETTING = { totalQuestionsMain: 67, totalQuestionsShort: 15 };
        this.DEFAULT_STATE = { questions: [], questionNumber: 0, totalQuestions: 15 };
        this.DEFAULT_MAIN_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsMain
        };
        this.DEFAULT_SHORT_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsShort
        };
    }
    SettingsService.getInstance = function () {
        return SettingsService._instance;
    };
    SettingsService.prototype.createSetting = function () {
        if (appSettings.hasKey(SETTINGS)) {
            var cacheSet = this.readSettings();
            this.DEFAULT_MAIN_STATE.totalQuestions = cacheSet.totalQuestionsMain;
            this.DEFAULT_SHORT_STATE.totalQuestions = cacheSet.totalQuestionsShort;
        }
        if (!appSettings.hasKey(SettingsService.MAIN)) {
            this.saveCache(SettingsService.MAIN, this.DEFAULT_MAIN_STATE);
        }
        if (!appSettings.hasKey(SettingsService.SHORT)) {
            this.saveCache(SettingsService.SHORT, this.DEFAULT_SHORT_STATE);
        }
    };
    SettingsService.prototype.readSettings = function () {
        var setting;
        try {
            setting = appSettings.hasKey(SETTINGS) ? JSON.parse(appSettings.getString(SETTINGS)) :
                this.DEFAULT_SETTING;
        }
        catch (error) {
            setting = this.DEFAULT_SETTING;
        }
        return setting;
    };
    SettingsService.prototype.readCache = function (mode) {
        var state;
        try {
            state = appSettings.hasKey(mode) ? JSON.parse(appSettings.getString(mode)) : this.DEFAULT_STATE;
        }
        catch (error) {
            state = this.DEFAULT_STATE;
        }
        return state;
    };
    SettingsService.prototype.saveCache = function (mode, state) {
        var newState = JSON.stringify(state);
        appSettings.setString(mode, newState);
    };
    SettingsService.prototype.clearCache = function (mode) {
        appSettings.remove(mode);
    };
    SettingsService.prototype.clearAll = function () {
        if (SettingsService.CLEAR || !appSettings.hasKey(SettingsService.VERSION) || appSettings.getNumber(SettingsService.VERSION) < SettingsService.VERSION_NUMBER) {
            this.clearCache(SettingsService.MAIN);
            this.clearCache(SettingsService.SHORT);
            this.clearCache(SettingsService.QUESTIONS);
        }
        appSettings.setNumber(SettingsService.VERSION, SettingsService.VERSION_NUMBER);
    };
    SettingsService.prototype.saveSetting = function (setting) {
        var newSetting = JSON.stringify(setting);
        appSettings.setString(SETTINGS, newSetting);
        var state = this.readCache(SettingsService.MAIN);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsMain;
            this.saveCache(SettingsService.MAIN, state);
        }
        state = this.readCache(SettingsService.SHORT);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsShort;
            this.saveCache(SettingsService.SHORT, state);
        }
    };
    SettingsService.prototype.saveQuestions = function (questions) {
        var json = JSON.stringify(questions);
        appSettings.setString(SettingsService.QUESTIONS, json);
    };
    SettingsService.prototype.readQuestions = function () {
        var questions;
        try {
            questions = this.hasQuestions() ? JSON.parse(appSettings.getString(SettingsService.QUESTIONS)) : [];
        }
        catch (error) {
            questions = [];
        }
        return questions;
    };
    SettingsService.prototype.hasQuestions = function () {
        return appSettings.hasKey(SettingsService.QUESTIONS);
    };
    SettingsService._instance = new SettingsService();
    SettingsService.VERSION_NUMBER = 3;
    SettingsService.CLEAR = false;
    SettingsService.VERSION = "VERSION";
    SettingsService.MAIN = "main";
    SettingsService.SHORT = "short";
    SettingsService.QUESTIONS = "questions";
    return SettingsService;
}());
exports.SettingsService = SettingsService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNldHRpbmdzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrREFBb0Q7QUFHcEQsSUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDO0FBRTVCO0lBQUE7UUFjSSxvQkFBZSxHQUFhLEVBQUMsa0JBQWtCLEVBQUUsRUFBRSxFQUFFLG1CQUFtQixFQUFFLEVBQUUsRUFBQyxDQUFDO1FBQ3RFLGtCQUFhLEdBQVUsRUFBQyxTQUFTLEVBQUUsRUFBRSxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBQyxDQUFDO1FBQ3RGLHVCQUFrQixHQUFVO1lBQ3hCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsY0FBYyxFQUFFLENBQUM7WUFDakIsY0FBYyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsa0JBQWtCO1NBQzFELENBQUM7UUFFTSx3QkFBbUIsR0FBVTtZQUNqQyxTQUFTLEVBQUUsRUFBRTtZQUNiLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLGNBQWMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQjtTQUMzRCxDQUFDO0lBeUZOLENBQUM7SUFqSFUsMkJBQVcsR0FBbEI7UUFDSSxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztJQUNyQyxDQUFDO0lBd0JELHVDQUFhLEdBQWI7UUFDSSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixJQUFNLFFBQVEsR0FBYSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDL0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUMsa0JBQWtCLENBQUM7WUFDckUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUMsbUJBQW1CLENBQUM7UUFDM0UsQ0FBQztRQUNELEVBQUUsQ0FB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QyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2IsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNuQixDQUFDO1FBQ0QsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNyQixDQUFDO0lBRUQsc0NBQVksR0FBWjtRQUNJLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBNUdjLHlCQUFTLEdBQW9CLElBQUksZUFBZSxFQUFFLENBQUM7SUFFM0QsOEJBQWMsR0FBVyxDQUFDLENBQUM7SUFDM0IscUJBQUssR0FBWSxLQUFLLENBQUM7SUFDdkIsdUJBQU8sR0FBVyxTQUFTLENBQUM7SUFDNUIsb0JBQUksR0FBVyxNQUFNLENBQUM7SUFDdEIscUJBQUssR0FBVyxPQUFPLENBQUM7SUFDeEIseUJBQVMsR0FBVyxXQUFXLENBQUM7SUFzRzNDLHNCQUFDO0NBQUEsQUFuSEQsSUFtSEM7QUFuSFksMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhcHBTZXR0aW5ncyBmcm9tICdhcHBsaWNhdGlvbi1zZXR0aW5ncyc7XHJcbmltcG9ydCB7SVF1ZXN0aW9uLCBJU2V0dGluZywgU3RhdGV9IGZyb20gXCIuLi9zaGFyZWQvcXVlc3Rpb25zLm1vZGVsXCI7XHJcblxyXG5jb25zdCBTRVRUSU5HUyA9IFwiU0VUVElOR1NcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBTZXR0aW5nc1NlcnZpY2Uge1xyXG5cclxuICAgIHN0YXRpYyBnZXRJbnN0YW5jZSgpOiBTZXR0aW5nc1NlcnZpY2Uge1xyXG4gICAgICAgIHJldHVybiBTZXR0aW5nc1NlcnZpY2UuX2luc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZTogU2V0dGluZ3NTZXJ2aWNlID0gbmV3IFNldHRpbmdzU2VydmljZSgpO1xyXG5cclxuICAgIHN0YXRpYyBWRVJTSU9OX05VTUJFUjogbnVtYmVyID0gMztcclxuICAgIHN0YXRpYyBDTEVBUjogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgc3RhdGljIFZFUlNJT046IHN0cmluZyA9IFwiVkVSU0lPTlwiO1xyXG4gICAgc3RhdGljIE1BSU46IHN0cmluZyA9IFwibWFpblwiO1xyXG4gICAgc3RhdGljIFNIT1JUOiBzdHJpbmcgPSBcInNob3J0XCI7XHJcbiAgICBzdGF0aWMgUVVFU1RJT05TOiBzdHJpbmcgPSBcInF1ZXN0aW9uc1wiO1xyXG4gICAgREVGQVVMVF9TRVRUSU5HOiBJU2V0dGluZyA9IHt0b3RhbFF1ZXN0aW9uc01haW46IDY3LCB0b3RhbFF1ZXN0aW9uc1Nob3J0OiAxNX07XHJcbiAgICBwcml2YXRlIERFRkFVTFRfU1RBVEU6IFN0YXRlID0ge3F1ZXN0aW9uczogW10sIHF1ZXN0aW9uTnVtYmVyOiAwLCB0b3RhbFF1ZXN0aW9uczogMTV9O1xyXG4gICAgREVGQVVMVF9NQUlOX1NUQVRFOiBTdGF0ZSA9IHtcclxuICAgICAgICBxdWVzdGlvbnM6IFtdLFxyXG4gICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgIHRvdGFsUXVlc3Rpb25zOiB0aGlzLkRFRkFVTFRfU0VUVElORy50b3RhbFF1ZXN0aW9uc01haW5cclxuICAgIH07XHJcblxyXG4gICAgcHJpdmF0ZSBERUZBVUxUX1NIT1JUX1NUQVRFOiBTdGF0ZSA9IHtcclxuICAgICAgICBxdWVzdGlvbnM6IFtdLFxyXG4gICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgIHRvdGFsUXVlc3Rpb25zOiB0aGlzLkRFRkFVTFRfU0VUVElORy50b3RhbFF1ZXN0aW9uc1Nob3J0XHJcbiAgICB9O1xyXG5cclxuICAgIGNyZWF0ZVNldHRpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGFwcFNldHRpbmdzLmhhc0tleShTRVRUSU5HUykpIHtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGVTZXQ6IElTZXR0aW5nID0gdGhpcy5yZWFkU2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgdGhpcy5ERUZBVUxUX01BSU5fU1RBVEUudG90YWxRdWVzdGlvbnMgPSBjYWNoZVNldC50b3RhbFF1ZXN0aW9uc01haW47XHJcbiAgICAgICAgICAgIHRoaXMuREVGQVVMVF9TSE9SVF9TVEFURS50b3RhbFF1ZXN0aW9ucyA9IGNhY2hlU2V0LnRvdGFsUXVlc3Rpb25zU2hvcnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5NQUlOKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNhdmVDYWNoZShTZXR0aW5nc1NlcnZpY2UuTUFJTiwgdGhpcy5ERUZBVUxUX01BSU5fU1RBVEUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWFwcFNldHRpbmdzLmhhc0tleShTZXR0aW5nc1NlcnZpY2UuU0hPUlQpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZUNhY2hlKFNldHRpbmdzU2VydmljZS5TSE9SVCwgdGhpcy5ERUZBVUxUX1NIT1JUX1NUQVRFKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVhZFNldHRpbmdzKCk6IElTZXR0aW5nIHtcclxuICAgICAgICBsZXQgc2V0dGluZzogSVNldHRpbmc7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgc2V0dGluZyA9IGFwcFNldHRpbmdzLmhhc0tleShTRVRUSU5HUykgPyBKU09OLnBhcnNlKGFwcFNldHRpbmdzLmdldFN0cmluZyhTRVRUSU5HUykpIDpcclxuICAgICAgICAgICAgICAgIHRoaXMuREVGQVVMVF9TRVRUSU5HO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHNldHRpbmcgPSB0aGlzLkRFRkFVTFRfU0VUVElORztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzZXR0aW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHJlYWRDYWNoZShtb2RlOiBzdHJpbmcpOiBTdGF0ZSB7XHJcbiAgICAgICAgbGV0IHN0YXRlOiBTdGF0ZTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBzdGF0ZSA9IGFwcFNldHRpbmdzLmhhc0tleShtb2RlKSA/IEpTT04ucGFyc2UoYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKG1vZGUpKSA6IHRoaXMuREVGQVVMVF9TVEFURTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBzdGF0ZSA9IHRoaXMuREVGQVVMVF9TVEFURTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVDYWNoZShtb2RlOiBzdHJpbmcsIHN0YXRlOiBTdGF0ZSk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG5ld1N0YXRlOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShzdGF0ZSk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKG1vZGUsIG5ld1N0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckNhY2hlKG1vZGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnJlbW92ZShtb2RlKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckFsbCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAoU2V0dGluZ3NTZXJ2aWNlLkNMRUFSIHx8ICFhcHBTZXR0aW5ncy5oYXNLZXkoU2V0dGluZ3NTZXJ2aWNlLlZFUlNJT04pIHx8IGFwcFNldHRpbmdzLmdldE51bWJlcihTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTikgPCBTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTl9OVU1CRVIpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOKTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5TSE9SVCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0TnVtYmVyKFNldHRpbmdzU2VydmljZS5WRVJTSU9OLCBTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTl9OVU1CRVIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVTZXR0aW5nKHNldHRpbmc6IElTZXR0aW5nKSB7XHJcbiAgICAgICAgY29uc3QgbmV3U2V0dGluZzogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoc2V0dGluZyk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKFNFVFRJTkdTLCBuZXdTZXR0aW5nKTtcclxuICAgICAgICBsZXQgc3RhdGU6IFN0YXRlID0gdGhpcy5yZWFkQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLk1BSU4pO1xyXG4gICAgICAgIGlmIChzZXR0aW5nLnRvdGFsUXVlc3Rpb25zTWFpbiA+IHN0YXRlLnRvdGFsUXVlc3Rpb25zKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnRvdGFsUXVlc3Rpb25zID0gc2V0dGluZy50b3RhbFF1ZXN0aW9uc01haW47XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZUNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOLCBzdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN0YXRlID0gdGhpcy5yZWFkQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlNIT1JUKTtcclxuICAgICAgICBpZiAoc2V0dGluZy50b3RhbFF1ZXN0aW9uc01haW4gPiBzdGF0ZS50b3RhbFF1ZXN0aW9ucykge1xyXG4gICAgICAgICAgICBzdGF0ZS50b3RhbFF1ZXN0aW9ucyA9IHNldHRpbmcudG90YWxRdWVzdGlvbnNTaG9ydDtcclxuICAgICAgICAgICAgdGhpcy5zYXZlQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlNIT1JULCBzdGF0ZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVF1ZXN0aW9ucyhxdWVzdGlvbnM6IEFycmF5PElRdWVzdGlvbj4pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBqc29uOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShxdWVzdGlvbnMpO1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnNldFN0cmluZyhTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TLCBqc29uKTtcclxuICAgIH1cclxuXHJcbiAgICByZWFkUXVlc3Rpb25zKCk6IEFycmF5PElRdWVzdGlvbj4ge1xyXG4gICAgICAgIGxldCBxdWVzdGlvbnM6IEFycmF5PElRdWVzdGlvbj47XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcXVlc3Rpb25zID0gdGhpcy5oYXNRdWVzdGlvbnMoKSA/IEpTT04ucGFyc2UoYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMpKSA6IFtdO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9ucyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcXVlc3Rpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc1F1ZXN0aW9ucygpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMpO1xyXG4gICAgfVxyXG59Il19