"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var appSettings = require("application-settings");
var navigationModule = require("../shared/navigation");
var SETTINGS = "SETTINGS";
var SettingsService = /** @class */ (function () {
    function SettingsService() {
        this.DEFAULT_SETTING = { totalQuestionsMain: 67, totalQuestionsQuick: 15 };
        this.DEFAULT_MAIN_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsMain
        };
        this.DEFAULT_QUICK_STATE = {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.DEFAULT_SETTING.totalQuestionsQuick
        };
        this.clearAll();
        this.createSetting();
    }
    SettingsService.getInstance = function () {
        return SettingsService._instance;
    };
    SettingsService.prototype.createSetting = function () {
        if (appSettings.hasKey(SETTINGS)) {
            var cacheSet = this.readSettings();
            this.DEFAULT_MAIN_STATE.totalQuestions = cacheSet.totalQuestionsMain;
            this.DEFAULT_QUICK_STATE.totalQuestions = cacheSet.totalQuestionsQuick;
        }
        if (!appSettings.hasKey(SettingsService.MAIN)) {
            this.saveCache(SettingsService.MAIN, this.DEFAULT_MAIN_STATE);
        }
        if (!appSettings.hasKey(SettingsService.QUICK)) {
            this.saveCache(SettingsService.QUICK, this.DEFAULT_QUICK_STATE);
        }
    };
    SettingsService.prototype.readSettings = function () {
        var setting;
        try {
            setting = appSettings.hasKey(SETTINGS) ? JSON.parse(appSettings.getString(SETTINGS)) :
                this.DEFAULT_SETTING;
        }
        catch (error) {
            setting = this.DEFAULT_SETTING;
        }
        return setting;
    };
    SettingsService.prototype.readCache = function (mode) {
        var state = appSettings.hasKey(mode) ? JSON.parse(appSettings.getString(mode)) : mode === SettingsService.MAIN ? this.DEFAULT_MAIN_STATE : this.DEFAULT_QUICK_STATE;
        return state;
    };
    SettingsService.prototype.saveCache = function (mode, state) {
        var newState = JSON.stringify(state);
        appSettings.setString(mode, newState);
    };
    SettingsService.prototype.clearCache = function (mode) {
        appSettings.remove(mode);
    };
    SettingsService.prototype.clearAll = function () {
        if (SettingsService.CLEAR || !appSettings.hasKey(SettingsService.VERSION) || appSettings.getNumber(SettingsService.VERSION) < SettingsService.VERSION_NUMBER) {
            this.clearCache(SettingsService.MAIN);
            this.clearCache(SettingsService.QUICK);
            this.clearCache(SettingsService.QUESTIONS);
            this.clearCache(SettingsService.QUICK1);
            this.clearCache(SettingsService.ROUTE);
        }
        this.clearCache(SettingsService.PRACTICE);
        appSettings.setNumber(SettingsService.VERSION, SettingsService.VERSION_NUMBER);
    };
    SettingsService.prototype.saveSetting = function (setting) {
        var newSetting = JSON.stringify(setting);
        appSettings.setString(SETTINGS, newSetting);
        var state = this.readCache(SettingsService.MAIN);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsMain;
            this.saveCache(SettingsService.MAIN, state);
        }
        state = this.readCache(SettingsService.QUICK);
        if (setting.totalQuestionsMain > state.totalQuestions) {
            state.totalQuestions = setting.totalQuestionsQuick;
            this.saveCache(SettingsService.QUICK, state);
        }
    };
    SettingsService.prototype.saveQuestions = function (questions) {
        var json = JSON.stringify(questions);
        appSettings.setString(SettingsService.QUESTIONS, json);
    };
    SettingsService.prototype.readQuestions = function () {
        var questions;
        try {
            questions = this.hasQuestions() ? JSON.parse(appSettings.getString(SettingsService.QUESTIONS)) : [];
        }
        catch (error) {
            questions = [];
        }
        return questions;
    };
    SettingsService.prototype.saveRoute = function (path) {
        appSettings.setString(SettingsService.ROUTE, path);
    };
    SettingsService.prototype.getRoute = function () {
        if (appSettings.hasKey(SettingsService.ROUTE)) {
            return appSettings.getString(SettingsService.ROUTE);
        }
        return "question/practice";
    };
    SettingsService.prototype.hasQuestions = function () {
        return appSettings.hasKey(SettingsService.QUESTIONS);
    };
    SettingsService.route = function () {
        var path = SettingsService.getInstance().getRoute();
        if (!path.includes(SettingsService.PRACTICE)) {
            navigationModule.toPage(path);
            return true;
        }
        return false;
    };
    SettingsService.VERSION_NUMBER = 9;
    SettingsService.CLEAR = false;
    SettingsService.VERSION = "VERSION";
    SettingsService.MAIN = "main";
    SettingsService.QUICK = "quick";
    SettingsService.QUICK1 = "short";
    SettingsService.PRACTICE = "practice";
    SettingsService.ROUTE = "route";
    SettingsService.QUESTIONS = "questions";
    SettingsService._instance = new SettingsService();
    return SettingsService;
}());
exports.SettingsService = SettingsService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNldHRpbmdzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrREFBb0Q7QUFFcEQsdURBQXlEO0FBRXpELElBQU0sUUFBUSxHQUFVLFVBQVUsQ0FBQztBQUVuQztJQStCSTtRQXBCQSxvQkFBZSxHQUFhLEVBQUMsa0JBQWtCLEVBQUUsRUFBRSxFQUFFLG1CQUFtQixFQUFFLEVBQUUsRUFBQyxDQUFDO1FBQzlFLHVCQUFrQixHQUFVO1lBQ3hCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsY0FBYyxFQUFFLENBQUM7WUFDakIsY0FBYyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsa0JBQWtCO1NBQzFELENBQUM7UUFFTSx3QkFBbUIsR0FBVTtZQUNqQyxTQUFTLEVBQUUsRUFBRTtZQUNiLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLGNBQWMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQjtTQUMzRCxDQUFDO1FBVUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBVE0sMkJBQVcsR0FBbEI7UUFDSSxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztJQUNyQyxDQUFDO0lBU00sdUNBQWEsR0FBcEI7UUFDSSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixJQUFNLFFBQVEsR0FBYSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDL0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUMsa0JBQWtCLENBQUM7WUFDckUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUMsbUJBQW1CLENBQUM7UUFDM0UsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMs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LHVCQUFPLEdBQVcsU0FBUyxDQUFDO0lBQzVCLG9CQUFJLEdBQVcsTUFBTSxDQUFDO0lBQ3RCLHFCQUFLLEdBQVcsT0FBTyxDQUFDO0lBQ3hCLHNCQUFNLEdBQVcsT0FBTyxDQUFDO0lBQ3pCLHdCQUFRLEdBQVcsVUFBVSxDQUFDO0lBQzlCLHFCQUFLLEdBQVcsT0FBTyxDQUFDO0lBQ3hCLHlCQUFTLEdBQVcsV0FBVyxDQUFDO0lBbUJ4Qix5QkFBUyxHQUFvQixJQUFJLGVBQWUsRUFBRSxDQUFDO0lBK0d0RSxzQkFBQztDQUFBLEFBNUlELElBNElDO0FBNUlZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXBwU2V0dGluZ3MgZnJvbSAnYXBwbGljYXRpb24tc2V0dGluZ3MnO1xyXG5pbXBvcnQge0lRdWVzdGlvbiwgSVNldHRpbmcsIFN0YXRlfSBmcm9tIFwiLi4vc2hhcmVkL3F1ZXN0aW9ucy5tb2RlbFwiO1xyXG5pbXBvcnQgKiBhcyBuYXZpZ2F0aW9uTW9kdWxlIGZyb20gJy4uL3NoYXJlZC9uYXZpZ2F0aW9uJztcclxuXHJcbmNvbnN0IFNFVFRJTkdTOnN0cmluZyA9IFwiU0VUVElOR1NcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBTZXR0aW5nc1NlcnZpY2Uge1xyXG5cclxuICAgIHN0YXRpYyBWRVJTSU9OX05VTUJFUjogbnVtYmVyID0gOTtcclxuICAgIHN0YXRpYyBDTEVBUjogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgc3RhdGljIFZFUlNJT046IHN0cmluZyA9IFwiVkVSU0lPTlwiO1xyXG4gICAgc3RhdGljIE1BSU46IHN0cmluZyA9IFwibWFpblwiO1xyXG4gICAgc3RhdGljIFFVSUNLOiBzdHJpbmcgPSBcInF1aWNrXCI7XHJcbiAgICBzdGF0aWMgUVVJQ0sxOiBzdHJpbmcgPSBcInNob3J0XCI7XHJcbiAgICBzdGF0aWMgUFJBQ1RJQ0U6IHN0cmluZyA9IFwicHJhY3RpY2VcIjtcclxuICAgIHN0YXRpYyBST1VURTogc3RyaW5nID0gXCJyb3V0ZVwiO1xyXG4gICAgc3RhdGljIFFVRVNUSU9OUzogc3RyaW5nID0gXCJxdWVzdGlvbnNcIjtcclxuICAgIERFRkFVTFRfU0VUVElORzogSVNldHRpbmcgPSB7dG90YWxRdWVzdGlvbnNNYWluOiA2NywgdG90YWxRdWVzdGlvbnNRdWljazogMTV9O1xyXG4gICAgREVGQVVMVF9NQUlOX1NUQVRFOiBTdGF0ZSA9IHtcclxuICAgICAgICBxdWVzdGlvbnM6IFtdLFxyXG4gICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgIHRvdGFsUXVlc3Rpb25zOiB0aGlzLkRFRkFVTFRfU0VUVElORy50b3RhbFF1ZXN0aW9uc01haW5cclxuICAgIH07XHJcblxyXG4gICAgcHJpdmF0ZSBERUZBVUxUX1FVSUNLX1NUQVRFOiBTdGF0ZSA9IHtcclxuICAgICAgICBxdWVzdGlvbnM6IFtdLFxyXG4gICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgIHRvdGFsUXVlc3Rpb25zOiB0aGlzLkRFRkFVTFRfU0VUVElORy50b3RhbFF1ZXN0aW9uc1F1aWNrXHJcbiAgICB9O1xyXG5cclxuXHJcbiAgICBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogU2V0dGluZ3NTZXJ2aWNlIHtcclxuICAgICAgICByZXR1cm4gU2V0dGluZ3NTZXJ2aWNlLl9pbnN0YW5jZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2U6IFNldHRpbmdzU2VydmljZSA9IG5ldyBTZXR0aW5nc1NlcnZpY2UoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcigpe1xyXG4gICAgICAgIHRoaXMuY2xlYXJBbGwoKTtcclxuICAgICAgICB0aGlzLmNyZWF0ZVNldHRpbmcoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY3JlYXRlU2V0dGluZygpOiB2b2lkIHtcclxuICAgICAgICBpZiAoYXBwU2V0dGluZ3MuaGFzS2V5KFNFVFRJTkdTKSkge1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZVNldDogSVNldHRpbmcgPSB0aGlzLnJlYWRTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICB0aGlzLkRFRkFVTFRfTUFJTl9TVEFURS50b3RhbFF1ZXN0aW9ucyA9IGNhY2hlU2V0LnRvdGFsUXVlc3Rpb25zTWFpbjtcclxuICAgICAgICAgICAgdGhpcy5ERUZBVUxUX1FVSUNLX1NUQVRFLnRvdGFsUXVlc3Rpb25zID0gY2FjaGVTZXQudG90YWxRdWVzdGlvbnNRdWljaztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFhcHBTZXR0aW5ncy5oYXNLZXkoU2V0dGluZ3NTZXJ2aWNlLk1BSU4pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZUNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOLCB0aGlzLkRFRkFVTFRfTUFJTl9TVEFURSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5RVUlDSykpIHtcclxuICAgICAgICAgICAgdGhpcy5zYXZlQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLLCB0aGlzLkRFRkFVTFRfUVVJQ0tfU1RBVEUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZWFkU2V0dGluZ3MoKTogSVNldHRpbmcge1xyXG4gICAgICAgIGxldCBzZXR0aW5nOiBJU2V0dGluZztcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBzZXR0aW5nID0gYXBwU2V0dGluZ3MuaGFzS2V5KFNFVFRJTkdTKSA/IEpTT04ucGFyc2UoYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKFNFVFRJTkdTKSkgOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5ERUZBVUxUX1NFVFRJTkc7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgc2V0dGluZyA9IHRoaXMuREVGQVVMVF9TRVRUSU5HO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc2V0dGluZztcclxuICAgIH1cclxuXHJcbiAgICByZWFkQ2FjaGUobW9kZTogc3RyaW5nKTogU3RhdGUge1xyXG4gICAgICAgIGxldCBzdGF0ZTogU3RhdGUgPSBhcHBTZXR0aW5ncy5oYXNLZXkobW9kZSkgPyBKU09OLnBhcnNlKGFwcFNldHRpbmdzLmdldFN0cmluZyhtb2RlKSkgOiBtb2RlID09PSBTZXR0aW5nc1NlcnZpY2UuTUFJTj8gdGhpcy5ERUZBVUxUX01BSU5fU1RBVEU6IHRoaXMuREVGQVVMVF9RVUlDS19TVEFURTtcclxuICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZUNhY2hlKG1vZGU6IHN0cmluZywgc3RhdGU6IFN0YXRlKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgbmV3U3RhdGU6IHN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHN0YXRlKTtcclxuICAgICAgICBhcHBTZXR0aW5ncy5zZXRTdHJpbmcobW9kZSwgbmV3U3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyQ2FjaGUobW9kZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgYXBwU2V0dGluZ3MucmVtb3ZlKG1vZGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyQWxsKCk6IHZvaWQge1xyXG4gICAgICAgIGlmIChTZXR0aW5nc1NlcnZpY2UuQ0xFQVIgfHwgIWFwcFNldHRpbmdzLmhhc0tleShTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTikgfHwgYXBwU2V0dGluZ3MuZ2V0TnVtYmVyKFNldHRpbmdzU2VydmljZS5WRVJTSU9OKSA8IFNldHRpbmdzU2VydmljZS5WRVJTSU9OX05VTUJFUikge1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLk1BSU4pO1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLKTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMpO1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLMSk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShTZXR0aW5nc1NlcnZpY2UuUk9VVEUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNsZWFyQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlBSQUNUSUNFKTtcclxuICAgICAgICBhcHBTZXR0aW5ncy5zZXROdW1iZXIoU2V0dGluZ3NTZXJ2aWNlLlZFUlNJT04sIFNldHRpbmdzU2VydmljZS5WRVJTSU9OX05VTUJFUik7XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVNldHRpbmcoc2V0dGluZzogSVNldHRpbmcpIHtcclxuICAgICAgICBjb25zdCBuZXdTZXR0aW5nOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShzZXR0aW5nKTtcclxuICAgICAgICBhcHBTZXR0aW5ncy5zZXRTdHJpbmcoU0VUVElOR1MsIG5ld1NldHRpbmcpO1xyXG4gICAgICAgIGxldCBzdGF0ZTogU3RhdGUgPSB0aGlzLnJlYWRDYWNoZShTZXR0aW5nc1NlcnZpY2UuTUFJTik7XHJcbiAgICAgICAgaWYgKHNldHRpbmcudG90YWxRdWVzdGlvbnNNYWluID4gc3RhdGUudG90YWxRdWVzdGlvbnMpIHtcclxuICAgICAgICAgICAgc3RhdGUudG90YWxRdWVzdGlvbnMgPSBzZXR0aW5nLnRvdGFsUXVlc3Rpb25zTWFpbjtcclxuICAgICAgICAgICAgdGhpcy5zYXZlQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLk1BSU4sIHN0YXRlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3RhdGUgPSB0aGlzLnJlYWRDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVJQ0spO1xyXG4gICAgICAgIGlmIChzZXR0aW5nLnRvdGFsUXVlc3Rpb25zTWFpbiA+IHN0YXRlLnRvdGFsUXVlc3Rpb25zKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnRvdGFsUXVlc3Rpb25zID0gc2V0dGluZy50b3RhbFF1ZXN0aW9uc1F1aWNrO1xyXG4gICAgICAgICAgICB0aGlzLnNhdmVDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVJQ0ssIHN0YXRlKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzYXZlUXVlc3Rpb25zKHF1ZXN0aW9uczogQXJyYXk8SVF1ZXN0aW9uPik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGpzb246IHN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHF1ZXN0aW9ucyk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMsIGpzb24pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlYWRRdWVzdGlvbnMoKTogQXJyYXk8SVF1ZXN0aW9uPiB7XHJcbiAgICAgICAgbGV0IHF1ZXN0aW9uczogQXJyYXk8SVF1ZXN0aW9uPjtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBxdWVzdGlvbnMgPSB0aGlzLmhhc1F1ZXN0aW9ucygpID8gSlNPTi5wYXJzZShhcHBTZXR0aW5ncy5nZXRTdHJpbmcoU2V0dGluZ3NTZXJ2aWNlLlFVRVNUSU9OUykpIDogW107XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgcXVlc3Rpb25zID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBxdWVzdGlvbnM7XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVJvdXRlKHBhdGg6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnNldFN0cmluZyhTZXR0aW5nc1NlcnZpY2UuUk9VVEUsIHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFJvdXRlKCk6IHN0cmluZ3tcclxuICAgICAgICBpZihhcHBTZXR0aW5ncy5oYXNLZXkoU2V0dGluZ3NTZXJ2aWNlLlJPVVRFKSl7XHJcbiAgICAgICAgICAgIHJldHVybiBhcHBTZXR0aW5ncy5nZXRTdHJpbmcoU2V0dGluZ3NTZXJ2aWNlLlJPVVRFKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFwicXVlc3Rpb24vcHJhY3RpY2VcIjtcclxuICAgIH1cclxuXHJcbiAgICBoYXNRdWVzdGlvbnMoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGFwcFNldHRpbmdzLmhhc0tleShTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgcm91dGUoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgbGV0IHBhdGggPSBTZXR0aW5nc1NlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRSb3V0ZSgpO1xyXG4gICAgICAgIGlmICghcGF0aC5pbmNsdWRlcyhTZXR0aW5nc1NlcnZpY2UuUFJBQ1RJQ0UpKSB7XHJcbiAgICAgICAgICAgIG5hdmlnYXRpb25Nb2R1bGUudG9QYWdlKHBhdGgpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG59Il19