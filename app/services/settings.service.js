"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var appSettings = require("application-settings");
var navigationModule = require("../shared/navigation");
var SETTINGS = "SETTINGS";
var ADDTICK = "ADDTICK";
var SettingsService = /** @class */ (function () {
    function SettingsService() {
        this.handleStructureChange();
        this.clearAll();
        this.createSetting();
    }
    SettingsService.getInstance = function () {
        return SettingsService._instance;
    };
    SettingsService.prototype.createSetting = function () {
        if (appSettings.hasKey(SETTINGS)) {
            this.setting = this.readSettings();
        }
        else {
            this.setting = this.getDefaultSetting();
            appSettings.setString(SETTINGS, JSON.stringify(this.setting));
        }
        if (!appSettings.hasKey(SettingsService.MAIN)) {
            this.saveCache(SettingsService.MAIN, this.getDefaultMain());
        }
        if (!appSettings.hasKey(SettingsService.QUICK)) {
            this.saveCache(SettingsService.QUICK, this.getDefaultQuick());
        }
        if (!appSettings.hasKey(SettingsService.TICK)) {
            this.saveCache(SettingsService.TICK, this.getDefaultTick());
        }
    };
    SettingsService.prototype.readSettings = function () {
        var setting;
        try {
            setting = appSettings.hasKey(SETTINGS) ? JSON.parse(appSettings.getString(SETTINGS)) : this.getDefaultSetting();
        }
        catch (error) {
            setting = this.getDefaultSetting();
        }
        return setting;
    };
    SettingsService.prototype.readCache = function (mode) {
        var state;
        if (appSettings.hasKey(mode)) {
            state = JSON.parse(appSettings.getString(mode));
        }
        else if (mode === SettingsService.MAIN) {
            state = this.getDefaultMain();
        }
        else if (mode === SettingsService.QUICK) {
            state = this.getDefaultQuick();
        }
        else if (mode === SettingsService.TICK) {
            state = this.getDefaultTick();
        }
        else {
            state = this.getDefaultQuick();
        }
        return state;
    };
    SettingsService.prototype.saveCache = function (mode, state) {
        var newState = JSON.stringify(state);
        appSettings.setString(mode, newState);
    };
    SettingsService.prototype.clearCache = function (mode) {
        appSettings.remove(mode);
    };
    SettingsService.prototype.clearAll = function () {
        if (SettingsService.CLEAR || !appSettings.hasKey(SettingsService.VERSION) || appSettings.getNumber(SettingsService.VERSION) < SettingsService.VERSION_NUMBER) {
            this.clearCache(SettingsService.MAIN);
            this.clearCache(SettingsService.QUICK);
            this.clearCache(SettingsService.QUESTIONS);
            this.clearCache(SettingsService.QUICK1);
            this.clearCache(SettingsService.ROUTE);
        }
        this.clearCache(SettingsService.PRACTICE);
        appSettings.setNumber(SettingsService.VERSION, SettingsService.VERSION_NUMBER);
    };
    SettingsService.prototype.saveSetting = function (setting) {
        var newSetting = JSON.stringify(setting);
        appSettings.setString(SETTINGS, newSetting);
    };
    SettingsService.prototype.saveQuestions = function (questions) {
        var json = JSON.stringify(questions);
        appSettings.setString(SettingsService.QUESTIONS, json);
        appSettings.setNumber(SettingsService.QUESTIONS_SIZE, questions.length);
    };
    SettingsService.prototype.saveVersion = function (fbVersion) {
        appSettings.setNumber(SettingsService.FB_VERSION, fbVersion);
    };
    SettingsService.prototype.readVersion = function () {
        return appSettings.hasKey(SettingsService.FB_VERSION) ? appSettings.getNumber(SettingsService.FB_VERSION) : 0;
    };
    SettingsService.prototype.readQuestions = function () {
        var questions;
        try {
            questions = this.hasQuestions() ? JSON.parse(appSettings.getString(SettingsService.QUESTIONS)) : [];
        }
        catch (error) {
            questions = [];
        }
        return questions;
    };
    SettingsService.prototype.saveRoute = function (path) {
        appSettings.setString(SettingsService.ROUTE, path);
    };
    SettingsService.prototype.getRoute = function () {
        if (appSettings.hasKey(SettingsService.ROUTE)) {
            return appSettings.getString(SettingsService.ROUTE);
        }
        return "question/practice";
    };
    SettingsService.prototype.saveScore = function (mode, percentage) {
        var key = 'stats' + mode;
        if (appSettings.hasKey(key)) {
            var items = JSON.parse(appSettings.getString(key));
            if (items.length >= 5) {
                items.shift();
            }
            items.push(percentage);
            appSettings.setString(key, JSON.stringify(items));
        }
        else {
            var items = new Array();
            items.push(percentage);
            appSettings.setString(key, JSON.stringify(items));
        }
    };
    SettingsService.prototype.getScore = function (mode) {
        var key = 'stats' + mode;
        var items = [];
        if (appSettings.hasKey(key)) {
            items = JSON.parse(appSettings.getString(key));
        }
        return items;
    };
    SettingsService.prototype.hasQuestions = function () {
        return appSettings.hasKey(SettingsService.QUESTIONS);
    };
    SettingsService.route = function () {
        var path = SettingsService.getInstance().getRoute();
        if (!path.includes(SettingsService.PRACTICE)) {
            navigationModule.toPage(path);
            return true;
        }
        return false;
    };
    SettingsService.prototype.getDefaultQuick = function () {
        return {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.readSettings().totalQuestionsQuick
        };
    };
    SettingsService.prototype.getDefaultMain = function () {
        return {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.readSettings().totalQuestionsMain
        };
    };
    SettingsService.prototype.getDefaultTick = function () {
        return {
            questions: [],
            questionNumber: 0,
            totalQuestions: this.readSettings().totalQuestionsTick,
            time: this.readSettings().totalTime
        };
    };
    SettingsService.prototype.handleStructureChange = function () {
        if (appSettings.hasKey(SETTINGS) && !appSettings.hasKey(ADDTICK)) {
            var setting = JSON.parse(appSettings.getString(SETTINGS));
            setting.totalQuestionsTick = this.getDefaultSetting().totalQuestionsTick;
            setting.totalTime = this.getDefaultSetting().totalTime;
            appSettings.setString(SETTINGS, JSON.stringify(setting));
            appSettings.setBoolean(ADDTICK, true);
        }
    };
    SettingsService.prototype.getDefaultSetting = function () {
        return {
            totalQuestionsMain: 67,
            totalQuestionsQuick: 15,
            totalTime: 110,
            totalQuestionsTick: 65
        };
    };
    SettingsService.prototype.hasSize = function () {
        return appSettings.hasKey(SettingsService.QUESTIONS_SIZE);
    };
    SettingsService.prototype.allQuestionsAsked = function (alreadyAsked) {
        return this.hasSize() ? alreadyAsked < appSettings.getNumber(SettingsService.QUESTIONS_SIZE) : alreadyAsked < 449;
    };
    SettingsService.VERSION_NUMBER = 10;
    SettingsService.CLEAR = false;
    SettingsService.VERSION = "VERSION";
    SettingsService.FB_VERSION = "FB_VERSION";
    SettingsService.MAIN = "main";
    SettingsService.TICK = "tick";
    SettingsService.QUICK = "quick";
    SettingsService.QUICK1 = "short";
    SettingsService.PRACTICE = "practice";
    SettingsService.ROUTE = "route";
    SettingsService.QUESTIONS = "questions";
    SettingsService.QUESTIONS_SIZE = "size";
    SettingsService._instance = new SettingsService();
    return SettingsService;
}());
exports.SettingsService = SettingsService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNldHRpbmdzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrREFBb0Q7QUFFcEQsdURBQXlEO0FBRXpELElBQU0sUUFBUSxHQUFXLFVBQVUsQ0FBQztBQUNwQyxJQUFNLE9BQU8sR0FBVyxTQUFTLENBQUM7QUFFbEM7SUFzQkk7UUFDSSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFWTSwyQkFBVyxHQUFsQjtRQUNJLE1BQU0sQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDO0lBQ3JDLENBQUM7SUFVTSx1Q0FBYSxHQUFwQjtRQUNJLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3ZDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDeEMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUNsRSxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxN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QUFLLEdBQVcsT0FBTyxDQUFDO0lBQ3hCLHlCQUFTLEdBQVcsV0FBVyxDQUFDO0lBQ2hDLDhCQUFjLEdBQVcsTUFBTSxDQUFDO0lBT3hCLHlCQUFTLEdBQW9CLElBQUksZUFBZSxFQUFFLENBQUM7SUEyTXRFLHNCQUFDO0NBQUEsQUEvTkQsSUErTkM7QUEvTlksMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhcHBTZXR0aW5ncyBmcm9tICdhcHBsaWNhdGlvbi1zZXR0aW5ncyc7XHJcbmltcG9ydCB7SVF1ZXN0aW9uLCBJU2V0dGluZywgU3RhdGV9IGZyb20gXCIuLi9zaGFyZWQvcXVlc3Rpb25zLm1vZGVsXCI7XHJcbmltcG9ydCAqIGFzIG5hdmlnYXRpb25Nb2R1bGUgZnJvbSAnLi4vc2hhcmVkL25hdmlnYXRpb24nO1xyXG5cclxuY29uc3QgU0VUVElOR1M6IHN0cmluZyA9IFwiU0VUVElOR1NcIjtcclxuY29uc3QgQUREVElDSzogc3RyaW5nID0gXCJBRERUSUNLXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgU2V0dGluZ3NTZXJ2aWNlIHtcclxuXHJcbiAgICBzdGF0aWMgVkVSU0lPTl9OVU1CRVI6IG51bWJlciA9IDEwO1xyXG4gICAgc3RhdGljIENMRUFSOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBzdGF0aWMgVkVSU0lPTjogc3RyaW5nID0gXCJWRVJTSU9OXCI7XHJcbiAgICBzdGF0aWMgRkJfVkVSU0lPTjogc3RyaW5nID0gXCJGQl9WRVJTSU9OXCI7XHJcbiAgICBzdGF0aWMgTUFJTjogc3RyaW5nID0gXCJtYWluXCI7XHJcbiAgICBzdGF0aWMgVElDSzogc3RyaW5nID0gXCJ0aWNrXCI7XHJcbiAgICBzdGF0aWMgUVVJQ0s6IHN0cmluZyA9IFwicXVpY2tcIjtcclxuICAgIHN0YXRpYyBRVUlDSzE6IHN0cmluZyA9IFwic2hvcnRcIjtcclxuICAgIHN0YXRpYyBQUkFDVElDRTogc3RyaW5nID0gXCJwcmFjdGljZVwiO1xyXG4gICAgc3RhdGljIFJPVVRFOiBzdHJpbmcgPSBcInJvdXRlXCI7XHJcbiAgICBzdGF0aWMgUVVFU1RJT05TOiBzdHJpbmcgPSBcInF1ZXN0aW9uc1wiO1xyXG4gICAgc3RhdGljIFFVRVNUSU9OU19TSVpFOiBzdHJpbmcgPSBcInNpemVcIjtcclxuICAgIHByaXZhdGUgc2V0dGluZzogSVNldHRpbmc7XHJcblxyXG4gICAgc3RhdGljIGdldEluc3RhbmNlKCk6IFNldHRpbmdzU2VydmljZSB7XHJcbiAgICAgICAgcmV0dXJuIFNldHRpbmdzU2VydmljZS5faW5zdGFuY2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBTZXR0aW5nc1NlcnZpY2UgPSBuZXcgU2V0dGluZ3NTZXJ2aWNlKCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5oYW5kbGVTdHJ1Y3R1cmVDaGFuZ2UoKTtcclxuICAgICAgICB0aGlzLmNsZWFyQWxsKCk7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVTZXR0aW5nKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNyZWF0ZVNldHRpbmcoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGFwcFNldHRpbmdzLmhhc0tleShTRVRUSU5HUykpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXR0aW5nID0gdGhpcy5yZWFkU2V0dGluZ3MoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNldHRpbmcgPSB0aGlzLmdldERlZmF1bHRTZXR0aW5nKCk7XHJcbiAgICAgICAgICAgIGFwcFNldHRpbmdzLnNldFN0cmluZyhTRVRUSU5HUywgSlNPTi5zdHJpbmdpZnkodGhpcy5zZXR0aW5nKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5NQUlOKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNhdmVDYWNoZShTZXR0aW5nc1NlcnZpY2UuTUFJTiwgdGhpcy5nZXREZWZhdWx0TWFpbigpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFhcHBTZXR0aW5ncy5oYXNLZXkoU2V0dGluZ3NTZXJ2aWNlLlFVSUNLKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNhdmVDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVJQ0ssIHRoaXMuZ2V0RGVmYXVsdFF1aWNrKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWFwcFNldHRpbmdzLmhhc0tleShTZXR0aW5nc1NlcnZpY2UuVElDSykpIHtcclxuICAgICAgICAgICAgdGhpcy5zYXZlQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlRJQ0ssIHRoaXMuZ2V0RGVmYXVsdFRpY2soKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlYWRTZXR0aW5ncygpOiBJU2V0dGluZyB7XHJcbiAgICAgICAgbGV0IHNldHRpbmc6IElTZXR0aW5nO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHNldHRpbmcgPSBhcHBTZXR0aW5ncy5oYXNLZXkoU0VUVElOR1MpID8gSlNPTi5wYXJzZShhcHBTZXR0aW5ncy5nZXRTdHJpbmcoU0VUVElOR1MpKSA6IHRoaXMuZ2V0RGVmYXVsdFNldHRpbmcoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBzZXR0aW5nID0gdGhpcy5nZXREZWZhdWx0U2V0dGluZygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc2V0dGluZztcclxuICAgIH1cclxuXHJcbiAgICByZWFkQ2FjaGUobW9kZTogc3RyaW5nKTogU3RhdGUge1xyXG4gICAgICAgIGxldCBzdGF0ZTogU3RhdGU7XHJcbiAgICAgICAgaWYgKGFwcFNldHRpbmdzLmhhc0tleShtb2RlKSkge1xyXG4gICAgICAgICAgICBzdGF0ZSA9IEpTT04ucGFyc2UoYXBwU2V0dGluZ3MuZ2V0U3RyaW5nKG1vZGUpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09IFNldHRpbmdzU2VydmljZS5NQUlOKSB7XHJcbiAgICAgICAgICAgIHN0YXRlID0gdGhpcy5nZXREZWZhdWx0TWFpbigpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gU2V0dGluZ3NTZXJ2aWNlLlFVSUNLKSB7XHJcbiAgICAgICAgICAgIHN0YXRlID0gdGhpcy5nZXREZWZhdWx0UXVpY2soKTtcclxuICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09IFNldHRpbmdzU2VydmljZS5USUNLKSB7XHJcbiAgICAgICAgICAgIHN0YXRlID0gdGhpcy5nZXREZWZhdWx0VGljaygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXRlID0gdGhpcy5nZXREZWZhdWx0UXVpY2soKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVDYWNoZShtb2RlOiBzdHJpbmcsIHN0YXRlOiBTdGF0ZSk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG5ld1N0YXRlOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShzdGF0ZSk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKG1vZGUsIG5ld1N0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckNhY2hlKG1vZGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnJlbW92ZShtb2RlKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckFsbCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAoU2V0dGluZ3NTZXJ2aWNlLkNMRUFSIHx8ICFhcHBTZXR0aW5ncy5oYXNLZXkoU2V0dGluZ3NTZXJ2aWNlLlZFUlNJT04pIHx8IGFwcFNldHRpbmdzLmdldE51bWJlcihTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTikgPCBTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTl9OVU1CRVIpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5NQUlOKTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5RVUlDSyk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TKTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5RVUlDSzEpO1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQ2FjaGUoU2V0dGluZ3NTZXJ2aWNlLlJPVVRFKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jbGVhckNhY2hlKFNldHRpbmdzU2VydmljZS5QUkFDVElDRSk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0TnVtYmVyKFNldHRpbmdzU2VydmljZS5WRVJTSU9OLCBTZXR0aW5nc1NlcnZpY2UuVkVSU0lPTl9OVU1CRVIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVTZXR0aW5nKHNldHRpbmc6IElTZXR0aW5nKSB7XHJcbiAgICAgICAgY29uc3QgbmV3U2V0dGluZzogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoc2V0dGluZyk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKFNFVFRJTkdTLCBuZXdTZXR0aW5nKTtcclxuICAgIH1cclxuXHJcbiAgICBzYXZlUXVlc3Rpb25zKHF1ZXN0aW9uczogQXJyYXk8SVF1ZXN0aW9uPik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGpzb246IHN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHF1ZXN0aW9ucyk7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKFNldHRpbmdzU2VydmljZS5RVUVTVElPTlMsIGpzb24pO1xyXG4gICAgICAgIGFwcFNldHRpbmdzLnNldE51bWJlcihTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TX1NJWkUsIHF1ZXN0aW9ucy5sZW5ndGgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVWZXJzaW9uKGZiVmVyc2lvbjogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0TnVtYmVyKFNldHRpbmdzU2VydmljZS5GQl9WRVJTSU9OLCBmYlZlcnNpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlYWRWZXJzaW9uKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIGFwcFNldHRpbmdzLmhhc0tleShTZXR0aW5nc1NlcnZpY2UuRkJfVkVSU0lPTikgPyBhcHBTZXR0aW5ncy5nZXROdW1iZXIoU2V0dGluZ3NTZXJ2aWNlLkZCX1ZFUlNJT04pIDogMDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcmVhZFF1ZXN0aW9ucygpOiBBcnJheTxJUXVlc3Rpb24+IHtcclxuICAgICAgICBsZXQgcXVlc3Rpb25zOiBBcnJheTxJUXVlc3Rpb24+O1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9ucyA9IHRoaXMuaGFzUXVlc3Rpb25zKCkgPyBKU09OLnBhcnNlKGFwcFNldHRpbmdzLmdldFN0cmluZyhTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TKSkgOiBbXTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBxdWVzdGlvbnMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHF1ZXN0aW9ucztcclxuICAgIH1cclxuXHJcbiAgICBzYXZlUm91dGUocGF0aDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgYXBwU2V0dGluZ3Muc2V0U3RyaW5nKFNldHRpbmdzU2VydmljZS5ST1VURSwgcGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Um91dGUoKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5ST1VURSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFwcFNldHRpbmdzLmdldFN0cmluZyhTZXR0aW5nc1NlcnZpY2UuUk9VVEUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gXCJxdWVzdGlvbi9wcmFjdGljZVwiO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVTY29yZShtb2RlOiBzdHJpbmcsIHBlcmNlbnRhZ2U6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIGxldCBrZXkgPSAnc3RhdHMnICsgbW9kZTtcclxuICAgICAgICBpZiAoYXBwU2V0dGluZ3MuaGFzS2V5KGtleSkpIHtcclxuICAgICAgICAgICAgbGV0IGl0ZW1zOiBBcnJheTxudW1iZXI+ID0gSlNPTi5wYXJzZShhcHBTZXR0aW5ncy5nZXRTdHJpbmcoa2V5KSk7XHJcbiAgICAgICAgICAgIGlmIChpdGVtcy5sZW5ndGggPj0gNSkge1xyXG4gICAgICAgICAgICAgICAgaXRlbXMuc2hpZnQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpdGVtcy5wdXNoKHBlcmNlbnRhZ2UpO1xyXG4gICAgICAgICAgICBhcHBTZXR0aW5ncy5zZXRTdHJpbmcoa2V5LCBKU09OLnN0cmluZ2lmeShpdGVtcykpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCBpdGVtcyA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgICAgICBpdGVtcy5wdXNoKHBlcmNlbnRhZ2UpO1xyXG4gICAgICAgICAgICBhcHBTZXR0aW5ncy5zZXRTdHJpbmcoa2V5LCBKU09OLnN0cmluZ2lmeShpdGVtcykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTY29yZShtb2RlOiBzdHJpbmcpOiBBcnJheTxudW1iZXI+IHtcclxuICAgICAgICBsZXQga2V5ID0gJ3N0YXRzJyArIG1vZGU7XHJcbiAgICAgICAgbGV0IGl0ZW1zOiBBcnJheTxudW1iZXI+ID0gW107XHJcbiAgICAgICAgaWYgKGFwcFNldHRpbmdzLmhhc0tleShrZXkpKSB7XHJcbiAgICAgICAgICAgIGl0ZW1zID0gSlNPTi5wYXJzZShhcHBTZXR0aW5ncy5nZXRTdHJpbmcoa2V5KSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBpdGVtcztcclxuICAgIH1cclxuXHJcbiAgICBoYXNRdWVzdGlvbnMoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGFwcFNldHRpbmdzLmhhc0tleShTZXR0aW5nc1NlcnZpY2UuUVVFU1RJT05TKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgcm91dGUoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgbGV0IHBhdGggPSBTZXR0aW5nc1NlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRSb3V0ZSgpO1xyXG4gICAgICAgIGlmICghcGF0aC5pbmNsdWRlcyhTZXR0aW5nc1NlcnZpY2UuUFJBQ1RJQ0UpKSB7XHJcbiAgICAgICAgICAgIG5hdmlnYXRpb25Nb2R1bGUudG9QYWdlKHBhdGgpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGVmYXVsdFF1aWNrKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9uczogW10sXHJcbiAgICAgICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgICAgICB0b3RhbFF1ZXN0aW9uczogdGhpcy5yZWFkU2V0dGluZ3MoKS50b3RhbFF1ZXN0aW9uc1F1aWNrXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldERlZmF1bHRNYWluKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHF1ZXN0aW9uczogW10sXHJcbiAgICAgICAgICAgIHF1ZXN0aW9uTnVtYmVyOiAwLFxyXG4gICAgICAgICAgICB0b3RhbFF1ZXN0aW9uczogdGhpcy5yZWFkU2V0dGluZ3MoKS50b3RhbFF1ZXN0aW9uc01haW5cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGVmYXVsdFRpY2soKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcXVlc3Rpb25zOiBbXSxcclxuICAgICAgICAgICAgcXVlc3Rpb25OdW1iZXI6IDAsXHJcbiAgICAgICAgICAgIHRvdGFsUXVlc3Rpb25zOiB0aGlzLnJlYWRTZXR0aW5ncygpLnRvdGFsUXVlc3Rpb25zVGljayxcclxuICAgICAgICAgICAgdGltZTogdGhpcy5yZWFkU2V0dGluZ3MoKS50b3RhbFRpbWVcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlU3RydWN0dXJlQ2hhbmdlKCkge1xyXG4gICAgICAgIGlmIChhcHBTZXR0aW5ncy5oYXNLZXkoU0VUVElOR1MpICYmICFhcHBTZXR0aW5ncy5oYXNLZXkoQUREVElDSykpIHtcclxuICAgICAgICAgICAgbGV0IHNldHRpbmc6IElTZXR0aW5nID0gSlNPTi5wYXJzZShhcHBTZXR0aW5ncy5nZXRTdHJpbmcoU0VUVElOR1MpKTtcclxuICAgICAgICAgICAgc2V0dGluZy50b3RhbFF1ZXN0aW9uc1RpY2sgPSB0aGlzLmdldERlZmF1bHRTZXR0aW5nKCkudG90YWxRdWVzdGlvbnNUaWNrO1xyXG4gICAgICAgICAgICBzZXR0aW5nLnRvdGFsVGltZSA9IHRoaXMuZ2V0RGVmYXVsdFNldHRpbmcoKS50b3RhbFRpbWU7XHJcbiAgICAgICAgICAgIGFwcFNldHRpbmdzLnNldFN0cmluZyhTRVRUSU5HUywgSlNPTi5zdHJpbmdpZnkoc2V0dGluZykpO1xyXG4gICAgICAgICAgICBhcHBTZXR0aW5ncy5zZXRCb29sZWFuKEFERFRJQ0ssIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldERlZmF1bHRTZXR0aW5nKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRvdGFsUXVlc3Rpb25zTWFpbjogNjcsXHJcbiAgICAgICAgICAgIHRvdGFsUXVlc3Rpb25zUXVpY2s6IDE1LFxyXG4gICAgICAgICAgICB0b3RhbFRpbWU6IDExMCxcclxuICAgICAgICAgICAgdG90YWxRdWVzdGlvbnNUaWNrOiA2NVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgaGFzU2l6ZSgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gYXBwU2V0dGluZ3MuaGFzS2V5KFNldHRpbmdzU2VydmljZS5RVUVTVElPTlNfU0laRSk7XHJcbiAgICB9XHJcblxyXG4gICAgYWxsUXVlc3Rpb25zQXNrZWQoYWxyZWFkeUFza2VkOiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5oYXNTaXplKCkgPyBhbHJlYWR5QXNrZWQgPCBhcHBTZXR0aW5ncy5nZXROdW1iZXIoU2V0dGluZ3NTZXJ2aWNlLlFVRVNUSU9OU19TSVpFKSA6IGFscmVhZHlBc2tlZCA8IDQ0OTtcclxuICAgIH1cclxufSJdfQ==